# Advanced Configuration Options

## Creating Persistent Storage

The Cassandra database should stores its data to persistent storage in order to prevent data loss.

For each Cassandra node you deploy, you will need a persistent volume with sufficient data available. You do not need to directly manage peristent volume claims as the deployer and templates will take care of that for you.

Please see the [OpenShift documentation](https://docs.openshift.org/latest/architecture/additional_concepts/storage.html) for how to setup and configure persistent volumes.

For example if you have a NFS server running on localhost with an exposed directory at `/persistent_storage/pv01`, the following command will generate a 10 gigabyte persistent volume:

	oc create -f - <<API
	apiVersion: v1
	kind: PersistentVolume
	metadata:
	  name: my_pv
	spec:
	  capacity:
	    storage: 10Gi
	  accessModes:
	    - ReadWriteOnce
	    - ReadWriteMany
	  persistentVolumeReclaimPolicy: Recycle
	  nfs:
	    server: localhost
	    path: /persistent_storage/pv01
	API

## Configuring the Deployer

### Create the Hawkular Deployer Secret

If you wish to provide any of your own certificates, then you will need to specify these certificates when creating the deployer secret.

The following is a list of configuration options which can be specifed as a secret for the deployer:

* hawkular-metrics.pem
	* The pem file used for the Hawkular Metrics certificate
	* if not specified: autogenerated
* hawkular-metrics-ca.cert
	* The certificate for the CA used to sign the hawkular-metrics.pem
	* required if hawkular-metrics.pem is specified, ignored otherwise
* hawkular-cassandra.pem
	* The pem file used for the Cassandra certificate
	* if not specified: autogenerated
* hawkular-cassandra-ca.cert
	* The certificate for the CA used to sign the hawkular-cassandra.pem
	* required if hawkular-cassandra-ca.cert is specified, ignored otherwise
* heapster.cert
	* The certificate used by Heapster
	* if not specified: autogenerated
* heapster.key
	* The key to be used with the heapster certificate
	* only required if heapster.cert is specified, ignored otherwise
* heapster_client_ca.cert
	* The certificate authority certificate used to generate heapster.cert
	* required if heapster.cert is specified, otherwise set to an autogenerated ca certificate
* heapster_allowed_users
	* A file containing a comma separated list of CN to accept from certificates signed with the specified CA
	* required if heapster.cert is specified, otherwise set to no allowed users
	
If the secrets to be used are placed all within a single directory, the following command will create the secret for you:

	oc secrets new metrics-deployer path/to/dir
	
If the secrets are not all located within a single directory, the following command can be used to specify the location of the files:

	oc secrets new metric-deployer hawkular-metrics.pem=/my/dir/hm.pem \
	                               hawkular-metrics-ca.cert=/my/dir/hm-ca.cert

### Deployer Template Options

The deployer template can accept the following options:

#### Template Parameters

The following are the various parameters the template will accept

#####IMAGE_PREFX
The prefix selected when the containers were built.

#####IMAGE_VERSION
The version selected when the containers were built.

##### HAWKULAR_METRICS_HOSTNAME
The hostname that hawkular metrics is going to be hosted under. This is used to generate the Hawkular Metrics certificate and is used for the host in the route configuration.

##### REDEPLOY
If the redeploy parameter is set to `true` it will delete all the components, service accounts, secrets and persistent volume claim. This will permanently delete any metrics which are stored.

##### MASTER_URL
The url to used for components to access the kubernetes master. Defaults to `https://kubernetes.default.svc:443`

##### CASSANDRA_NODES
How many initial Cassandra nodes should be deployed. This defaults to a single node cluster.

##### USE_PERSISTENT_STORAGE
If the deployment should use persistent storage or not. This defaults to true.

##### CASSANDRA_PV_SIZE
The requested size that each Cassandra node is requesting. This defaults to 1gi

##### METRIC_DURATION
How many days that metrics should be stored for. This defaults to 7 days.


## Cassandra Scaling

Since the Cassandra nodes use persistent storage, we cannot currently scale up or down using replication controllers.

In a subsequent release, nominal services will allow replication controllers to handle this type of scaling and these extra steps will not be needed. But for now a few extra steps are required.

In order to scale up a Cassandra cluster, you will need to use the `hawkular-cassandra-node` template.

By default, the Cassandra cluster is a single node cluster. To add a second node with 10Gi of storage, you would need to call the following command:

	oc process hawkular-cassandra-node-pv -v \
	"IMAGE_PREFIX=openshift/origin-,IMAGE_VERSION=devel,PV_SIZE=10Gi,NODE=2"
	
To deploy more nodes, you would need to just increase the `NODE` value.

Note: when you add a new node to a Cassandra cluster, the data stored in the cluster will rebalance across the cluster. The same thing will happen when you remove a node from the Cluster. Adding and removing Cassandra nodes can be an expensive operation.

